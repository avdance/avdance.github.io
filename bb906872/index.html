<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/avdance32_32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/avdance16_16.ico"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.avdancedu.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:"valine",storage:!0,lazyload:!1,nav:null,activeClass:"valine"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="在Janus的众多插件中，大家最感兴趣的恐怕就是VideoRoom插件了。因为它实现的是一个音视频会议的场景，这正是大多数同学所需要的。而且在Janus众多的插件中VideoRoom应该也是最复杂的一个，如果你们撑握了它，再去看其它插件的实现就容易多了。 在VideoRoom中，包括了很多API，这些API是我们打开VideoRoom的一把钥匙，所以本文的重点就是讲解这些API。我相信当你把这些"><meta property="og:type" content="article"><meta property="og:title" content="janus的videoroom插件"><meta property="og:url" content="https://blog.avdancedu.com/bb906872/index.html"><meta property="og:site_name" content="音视跳动科技"><meta property="og:description" content="在Janus的众多插件中，大家最感兴趣的恐怕就是VideoRoom插件了。因为它实现的是一个音视频会议的场景，这正是大多数同学所需要的。而且在Janus众多的插件中VideoRoom应该也是最复杂的一个，如果你们撑握了它，再去看其它插件的实现就容易多了。 在VideoRoom中，包括了很多API，这些API是我们打开VideoRoom的一把钥匙，所以本文的重点就是讲解这些API。我相信当你把这些"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.avdancedu.com/image/article/videoroom/videoroom.jpg"><meta property="article:published_time" content="2020-06-19T16:04:10.000Z"><meta property="article:modified_time" content="2020-06-29T05:31:16.443Z"><meta property="article:author" content="音视跳动"><meta property="article:tag" content="videoroom"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.avdancedu.com/image/article/videoroom/videoroom.jpg"><link rel="canonical" href="https://blog.avdancedu.com/bb906872/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>janus的videoroom插件 | 音视跳动科技</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="音视跳动科技" type="application/atom+xml"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="container"><div class="headband"></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div><header class="header" itemscope itemtype="https://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">音视跳动科技</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">传播最前沿的科技知识！</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div> <a href="https://github.com/avdance" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="https://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.avdancedu.com/bb906872/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="image" content="/images/avdancelogo.jpg"><meta itemprop="name" content="音视跳动"><meta itemprop="description" content="传输最前沿的科技知识，学习音视频的圣地！ffmpeg, webrtc, H264, AAC"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="音视跳动科技"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> janus的videoroom插件</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-20 00:04:10" itemprop="dateCreated datePublished" datetime="2020-06-20T00:04:10+08:00">2020-06-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-06-29 13:31:16" itemprop="dateModified" datetime="2020-06-29T13:31:16+08:00">2020-06-29</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/WebRTC/" itemprop="url" rel="index"><span itemprop="name">WebRTC</span></a></span></span><span id="/bb906872/" class="post-meta-item leancloud_visitors" data-flag-title="janus的videoroom插件" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/bb906872/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/bb906872/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>23k</span></span></div></header><div class="post-body" itemprop="articleBody"><p><img data-src="https://cdn.avdancedu.com/image/article/videoroom/videoroom.jpg" alt="videoroom"></p><p>在Janus的众多插件中，大家最感兴趣的恐怕就是<code>VideoRoom</code>插件了。因为它实现的是一个音视频会议的场景，这正是大多数同学所需要的。而且在Janus众多的插件中<code>VideoRoom</code>应该也是最复杂的一个，如果你们撑握了它，再去看其它插件的实现就容易多了。</p><p>在<code>VideoRoom</code>中，包括了很多API，这些API是我们打开<code>VideoRoom</code>的一把钥匙，所以本文的重点就是讲解这些API。我相信当你把这些API都撑握之后，再去看<code>VideoRoom</code>插件的代码时就会更加游刃有余了。</p><a id="more"></a><h2 id="VideoRoom插件"><a href="#VideoRoom插件" class="headerlink" title="VideoRoom插件"></a>VideoRoom插件</h2><p><code>VideoRoom</code>是Janus的一个插件，实现了一个SFU（Selective Forwarding Unit）型的音视频会议。如果你从数据转发的角度看，也可以把它认为是一个音视频<code>路由器</code>。</p><p><code>VideoRoom</code>实现的音视频会议是基于<code>发布/订阅</code>模式。每个<code>参与方</code>都可以发布自己的实时音视频流，因此它可以实现几种不同的场景，比如泛娱乐化直播或多人的实时互动产品(如音视频会议、在线教育小班课等）。</p><p>考虑到此插件允许一个<code>参与方</code>可以打开多个WebRTC <code>PeerConnection</code>（如每个<code>参与方</code>可以有1个用于推流的<code>PeerConnection</code>和N个拉流的<code>PeerConnection</code>），所以每个<code>参与方</code>需要为订阅不同的流<code>attach</code>到<code>VideoRoom</code>插件几次(每<code>attach</code>一次就会生成一个<code>Handle</code>，每个<code>Handle</code>就是一个上下文)。</p><p>因此，对于每个<code>参与方</code>至少要有一个<code>Handle</code>用于管理与插件的关系（如加入一个房间，离开一个房间，静音/取消静音，发布，接收事件）。</p><p>每当<code>参与方</code>需要订阅另一个参与方发布的音视频流时，它需要创建一个新的<code>Handle</code>。新创建的<code>Handle</code>在逻辑上属于<strong>“从”</strong><code>Handle</code>，它不能像<strong>“主”</strong><code>Handle</code>一样可以做取消房间静音这样的操作。因此，<strong>从</strong><code>Handle</code>唯一目的是提供一个上下文，在该上下文中创建一个<code>recvonly</code>类型的<code>PeerConnection</code>来订阅发布者的音视频流。</p><p>通过上面的描述我们可以知道，主Handle用于管理，而从Handle用于订阅音视频流。</p><blockquote><p>注意，现在<code>WebRTC</code>已经实现了SSRC复用（Unified Plan），这意味着你可以使用相同的<code>Janus Handle</code> 和<code>PeerConnection</code>同时接收多路音视频流。</p></blockquote><p>VideoRoom插件功能非常强大，也很灵活，它有很多的配置项，你可以通过<code>conf/janus.plugin.videoroom.jcfg</code>来修改它们。当然Janus也支持动态API修改配置，如通过API创建房间等。</p><p>要增加更多房间或修改现有房间信息，你可以向Janus发送下面格式的请求：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">room- &lt;唯一的房间ID&gt;：&#123;</span><br><span class="line">        description &#x3D; 房间的描述信息</span><br><span class="line">        is_private &#x3D; true | false（是否是私有房间? 如果创建的是私有房间，则无法通过list指令进行查看）</span><br><span class="line">        secret &#x3D; &lt;可选项，操作房间所需的密码，如果设置了，则像做销毁房间这样的操作时你要带上它才行&gt;</span><br><span class="line">        PIN &#x3D; &lt;可选项，加入会议房间的密码&gt;</span><br><span class="line">        require_pvtid &#x3D; true | false（是否订阅音视频流时，需要提供一个与发布者相关的有效private_id， 默认为false）</span><br><span class="line">        publishers &#x3D;  &lt;房间内发布者的最大数&gt;（例如，一个视频会议可以有6个发布者，而广播只有一个，默认&#x3D; 3）</span><br><span class="line">        bitrate &#x3D; &lt;房间里发布者发送数据的最大比特率&gt;（例如128000）</span><br><span class="line">        fir_freq &#x3D; &lt;向发布者发送FIR指令的频率&gt;（0 &#x3D;禁用）</span><br><span class="line">        audiocodec &#x3D; opus | g722 | pcmu | pcma | isac32 | isac16（发布者可以使用的音频编解码器列表，默认为opus。编码器按优先顺序以逗号分隔）</span><br><span class="line">        videocodec &#x3D; vp8 | vp9 | h264 | av1 | h265（发布者可以使用的视频编解码器列表，默认为vp8。可以按优先级顺序用逗号分隔，例如，vp9，vp8，h264）</span><br><span class="line">        vp9_profile &#x3D; VP9首选的profile(&quot;2&quot; 表示 &quot;profile-id &#x3D; 2&quot; ）</span><br><span class="line">        h264_profile &#x3D; H.264首选的profile（&quot;42e01f&quot; 表示 &quot;profile-level-id &#x3D; 42e01f&quot; ）</span><br><span class="line">        opus_fec &#x3D; true | false（是否使用带内FEC；仅适用于Opus，默认为false）</span><br><span class="line">        video_svc &#x3D; true | false（是否启用SVC支持；仅适用于VP9，默认为false）</span><br><span class="line">        audiolevel_ext &#x3D; true | false（对于发布者是否使用RTP扩展ssrc-audio-level？默认为 true）</span><br><span class="line">        audiolevel_event &#x3D; true | false（是否将audiolevel事件发送给其他用户）</span><br><span class="line">        audio_active_packets &#x3D; 100（音频保活包个数，默认值&#x3D; 100，2秒）</span><br><span class="line">        audio_level_average &#x3D; 25（音频音量级别的平均值，127 &#x3D;静音，0 &#x3D;&#39;太大声&#39;，默认&#x3D; 25）</span><br><span class="line">        videoorient_ext &#x3D; true | false（发布者是否使用RTP扩展video-orientation? 默认&#x3D; true）</span><br><span class="line">        playoutdelay_ext &#x3D; true | false（发布者是否使用RTP扩展playout-delay? 默认&#x3D; true）</span><br><span class="line">        transport_wide_cc_ext &#x3D; true | false（发布者是否使用RTP扩展 transport-wide-cc? 默认&#x3D; true）</span><br><span class="line">        record &#x3D; true | false（该房间是否启录制？默认&#x3D; false）</span><br><span class="line">        rec_dir &#x3D; &lt;启用录制后，录制文件存放的目录&gt;</span><br><span class="line">        lock_record &#x3D; true | false（是否锁定录制状态? 默认&#x3D; false）</span><br><span class="line">        notify_joining &#x3D; true | false（可选，当有新的参与方加入房音后，是否通知房间里的所有参与者?</span><br><span class="line">                                       Videoroom插件默认仅通知发布者，启用此功能可能会导致额外的通知传输。</span><br><span class="line">                                       该功能与require_pvtid一起启用时，对管理员管理仅收听的参与者特别有用。默认&#x3D; false）</span><br><span class="line">        require_e2ee &#x3D; true | false（是否启用端到端加密? 默认&#x3D; false）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Video-Room-可以使用的API"><a href="#Video-Room-可以使用的API" class="headerlink" title="Video Room 可以使用的API"></a>Video Room 可以使用的API</h2><p><code>VideoRoom</code> 插件支持很多API。这些API中，一些是同步请求，一些则是异步请求。但无论是同步还是异步请求，当遇到无效的JSON格式或无效的请求时，都使用同步进行错误响应。</p><p>接下来，我们首先看看都有那些同步请求API。<code>create</code>，<code>destroy</code>，<code>edit</code>，<code>exists</code>，<code>list</code>，<code>allowed</code>，<code>kick</code>和<code>listparticipants</code>是同步请求API。<code>create</code>允许您动态创建一个新的音视频房间；<code>edit</code>允许您动态编辑房间的属性（例如 修改PIN码）；<code>destroy</code>首先释放视频资源，然后踢除房间里的所有用户，最后销毁音视频房间；<code>exists</code>检查指定的音视频房间是否存在；<code>list</code>列出所有有效的音视频房间; <code>listparticipants</code>列出指定房间中所有激活的参与者及其详细信息。</p><p>异步请求API有：<code>join</code>，<code>joinandconfigure</code>，<code>configure</code>，<code>publish</code>，<code>unpublish</code>，<code>start</code>，<code>pause</code>，<code>switch</code>和<code>leave</code>。<code>join</code>允许你加入指定的音视频房间；<code>configure</code>可用于修改某些属性（例如，比特率范围）；<code>joinandconfigure</code>的含义是将前两个请求合并为一个请求（该请求仅适用于发布者）；<code>publish</code>发布媒体流给所有订阅者; <code>unpublish</code>正好与<code>publish</code>相反；<code>start</code>允许你开始接收订阅的媒体流；<code>pause</code>暂停发送媒体流；<code>switch</code>更改指定<code>PeerConnection</code>的媒体源（例如，你正在看A，现在改为看B），但无需为此创建新的Handle；<code>leave</code>离开视频房间。</p><p>下面咱们对上面提到的API做一下详细分析，首先看一下<code>create</code>API，它用于创建新的音视频房间，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;create&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;可选，房间ID。如果不填，则由插件随机生成&gt;，</span><br><span class="line">        &quot;permanent&quot;：&lt;true | false，是否创建永久房间，默认&#x3D; false&gt;，</span><br><span class="line">        &quot;description&quot;：&quot;&lt;可选，房间的名称&gt;&quot;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;可选，编辑&#x2F;销毁房间时用的密码&gt;&quot;，</span><br><span class="line">        &quot;pin&quot;：&quot;&lt;可选，加入房间的密码&gt;&quot;，</span><br><span class="line">        &quot;is_private&quot;：&lt;true | false，是否是私有房间？如果是私有房间则不会出现在房间列表中&gt;，</span><br><span class="line">        &quot;allowed&quot;：[可选，用户加入房间的token数组]，</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的说明已经非常清楚了，这里我就不做简赘述了。</p><p>如果<code>create</code>成功，则会返回<code>created</code>响应，格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：“created&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;permanent&quot;：&lt;是否是创建的永久房间？是则为true，否则为false&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，如果你请求创建一个永久房间，但<code>permanet</code>返回的是false，很可能是因为权限的问题导致的。</p></blockquote><p>如果<code>create</code>请求失败，则返回错误信息，格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;error_code&quot;：&lt;错误码，每个错误码的含义需要看插件实现代码中的宏定义&gt;，</span><br><span class="line">        &quot;error&quot;：&quot;&lt;错误描述字符串&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这里需要注意的是，所有请求的错误响应格式都与上面一样。</p></blockquote><p>默认情况下，所有用户都可以创建房间，但你可以通过在<code>VideoRoom</code>插件的配置文件中增加<code>admin_key</code>项来限制此功能。此时，只有带了正确的<code>admin_key</code>值的<code>create</code>请求才能成功创建房间。你也可以选择将此功能扩展到RTP转发，只转发受信任的客户端的RTP包。</p><p>房间创建好后，您可以用<code>edit</code>API编辑其中的部分（但不是全部）属性。<code>edit</code>允许你修改房间描述，密码，PIN码以及是否为私有。但你将无法修改他的静态属性，例如房间ID，采样率，与扩展相关的内容等。如果你有兴趣更改ACL，还需要查看<code>allowed</code>是否允许。</p><p>一个<code>edit</code>请求格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;edit&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;房间密码&gt;&quot;，</span><br><span class="line">        &quot;new_description&quot;：&quot;&lt;房间的新名称，可选&gt;&quot;，</span><br><span class="line">        &quot;new_secret&quot;：&quot;&lt;房间的新密码，可选&gt;&quot;，</span><br><span class="line">        &quot;new_pin&quot;：&quot;&lt;新PIN码，可选&gt;&quot;，</span><br><span class="line">        &quot;new_is_private&quot;：&lt;true | false，房间是否为私有房间?&gt;，</span><br><span class="line">        &quot;new_require_pvtid&quot;：&lt;true | false，房间是否要求订阅者提供private_id&gt;，</span><br><span class="line">        &quot;new_bitrate&quot;：&lt;比特率&gt;，</span><br><span class="line">        &quot;new_fir_freq&quot;：&lt;发送PLI请求关键帧的时间间隔&gt;，</span><br><span class="line">        &quot;new_publishers&quot;：&lt;房间里发布者的最大数&gt;，</span><br><span class="line">        &quot;new_lock_record&quot;：&lt;true | false，如否可以改变录制状态&gt;，</span><br><span class="line">        &quot;permanent&quot;：&lt;true | false，该房间是否是永久房间？默认&#x3D; false&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>edit</code>请求成功，刚收到<code>edited</code>响应：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;edited&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来我们来看看<code>destroy</code>API，无论你是通过动态创建的还是静态创建的房间，均可使用<code>destroy</code>销毁它，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;destroy&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;房间密码&gt;&quot;，</span><br><span class="line">        &quot;permanent&quot;：&lt;true | false，是否是永久房间，默认&#x3D; false&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功销毁房间后将收到<code>destroyed</code>响应，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;destroyed&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>销毁房间后，在房间内的所有参与者都会收到<code>destroyed</code>事件，如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;destroyed&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Janus中还提供了<code>exists</code>API，来检查房间是否存在，该请求的格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;exists&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求成功将收到success响应：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：“success&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        “exists&quot;：&lt;true | false 房间是否存在&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>allowed</code>API可以打开/关闭对令牌的检测，它还可以增加/删除允许的用户，其请求格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;allowed&quot;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;房间密码，如果已配置，则是必需的&gt;&quot;，</span><br><span class="line">        &quot;action&quot;：&quot;enable | disable | add | remove&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;allowed&quot;：[</span><br><span class="line">                &#x2F;&#x2F;字符串数组</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功请求将返回success响应：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：“success&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        “allowed&quot;：[</span><br><span class="line">                &#x2F;&#x2F;更新后完整的令牌列表</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你是房间管理员（即你创建了该房间并可以加密访问），则你可以使用<code>kick</code>API踢除房间内的用户。</p><blockquote><p>注意，这只会将用户踢出房间，但并不能阻止他们重新加入。要禁止他们加入，你需要先从授权用户列表中删除他们（请参阅allowed请求），然后再将其踢掉。<code>kick</code>请求的格式如下：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;kick&quot;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;房间密码&gt;&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;id&quot;：&lt;被踢用户ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求成功将收到success响应：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;success&quot;，</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你还可以通过<code>list</code>API获取可用房间的列表（不包括配置或创建为私有的房间），其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：“list&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求成功将返回success响应，响应中会带有有效的房间列表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：“成功&quot;，</span><br><span class="line">        &quot;rooms&quot;：[&#x2F;&#x2F;房间对象数组</span><br><span class="line">                &#123;&#x2F;&#x2F; 第一个房间</span><br><span class="line">                        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">                        &quot;description&quot;：&quot;&lt;房间名称&gt;&quot;，</span><br><span class="line">                        &quot;pin_required&quot;：&lt;true | false，是否需要输入PIN吗才能加入此房间&gt;，</span><br><span class="line">                        &quot;max_publishers&quot;：&lt;房间内发布者最大数量，&gt;</span><br><span class="line">                        &quot;bitrate&quot;：&lt;发布者使用的（通过REMB）比特率上限&gt;，</span><br><span class="line">                        &quot;bitrate_cap&quot;：&lt;true | false，上述上限是否可以动态更改?&gt;，</span><br><span class="line">                        &quot;fir_freq&quot;：&lt;发送PLI&#x2F;FIR请求关键帧的时间间隔&gt;，</span><br><span class="line">                        &quot;audiocodec&quot;：&quot;&lt;音频编解码器列表，每个编码器以逗号分隔&gt;&quot;，</span><br><span class="line">                        &quot;videocodec&quot;：&quot;&lt;视频编解码器列表，每个编码器以逗号分隔&gt;&quot;，</span><br><span class="line">                        &quot;record&quot;：&lt;true | false，是否打开了录制功能&gt;，</span><br><span class="line">                        &quot;record_dir&quot;：&quot;&lt;如果开启了录掉，.mjr文件保存的路径&gt;&quot;，</span><br><span class="line">                        &quot;lock_record&quot;：&lt;true | false，是否只能通过密码才能更改房间记录状态&gt;，</span><br><span class="line">                        &quot;num_participants&quot;：&lt;房间内参与人的个数&gt;</span><br><span class="line">                &#125;，</span><br><span class="line">                &#x2F;&#x2F;其他房间</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，你要获取特定房间中的参与者列表，可以使用<code>listparticipants</code>请求，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;listparticipants&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求成功将返回一个<code>participants</code>响应：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;participants&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        “participants&quot;：[&#x2F;&#x2F;参与者对象的数组</span><br><span class="line">                &#123;&#x2F;&#x2F;参与者＃1</span><br><span class="line">                        &quot;id&quot;：&lt;用户ID&gt;，</span><br><span class="line">                        &quot;display&quot;：&quot;&lt;用户名；可选&gt;&quot;，</span><br><span class="line">                        &quot;publisher&quot;：&quot;&lt;true | false，用户是否是房间的发布者&gt;&quot;，</span><br><span class="line">                        &quot;talking&quot;：&lt;true | false，用户是否可以说话（仅当使用音频级别时）&gt;</span><br><span class="line">                &#125;，</span><br><span class="line">                &#x2F;&#x2F;其他参与者</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面是Janus中的同步API。异步API都是与<code>参与者</code>有关，即<code>参与者</code>如何发布，订阅或管理他们正在发送或接收的媒体流。</p><h2 id="VideoRoom-发布者"><a href="#VideoRoom-发布者" class="headerlink" title="VideoRoom 发布者"></a>VideoRoom 发布者</h2><p>在VideoRoom中，<code>发布者</code>是指那些能够在房间中发布<code>媒体流</code>的参与者。</p><p>当你以<code>发布者</code>的身份加入到房间里时，您应该发送<code>join</code>请求，并且将ptype设置为<code>publisher</code>。请求的具体格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;join&quot;，</span><br><span class="line">        &quot;ptype&quot;：&quot;pbulisher&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;id&quot;：&lt;发布者ID；可选，如果缺少，将由插件选择&gt;，</span><br><span class="line">        &quot;display&quot;：&quot;&lt;发布者名称；可选&gt;&quot;，</span><br><span class="line">        &quot;token&quot;：&quot;&lt;邀请令牌，如果房间有ACL时需要该字段；可选&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>join</code>请求成功将收到<code>joined</code>事件，其中包含当前激活的<code>发布者</code>列表，以及任选的<code>参加者</code>列表。<code>joined</code>事件格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;joined&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;description&quot;：&lt;房间名，如果有的话&gt;，</span><br><span class="line">        &quot;id&quot;：&lt;用户ID&gt;，</span><br><span class="line">        &quot;private_id&quot;：&lt;与参与者相关联的不同唯一ID；打算是私人的&gt;，</span><br><span class="line">        “publishers&quot;：[</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;id&quot;：&lt;活动发布者＃1的唯一ID&gt;，</span><br><span class="line">                        &quot;display&quot;：&quot;&lt;发布者＃1的名称，如果有的话&gt;&quot;，</span><br><span class="line">                        &quot;audio_codec&quot;：&quot;&lt;发布者＃1使用的音频编解码器，如果有的话&gt;&quot;，</span><br><span class="line">                        &quot;video_codec&quot;：&quot;&lt;发布者＃1使用的视频编解码器，如果有的话&gt;&quot;，</span><br><span class="line">                        &quot;simulcast&quot;：&quot;&lt;如果发布者使用simulcast，则为true（仅VP8和H.264）&gt;&quot;，</span><br><span class="line">                        &quot;talking&quot;：&lt;true | false，发布者开启语音聊天（仅在使用音频级别的情况下）&gt;，</span><br><span class="line">                &#125;，</span><br><span class="line">                &#x2F;&#x2F;其他活跃的发布者</span><br><span class="line">        ]，</span><br><span class="line">        &quot;attendees&quot;：[&#x2F;&#x2F;仅当房间的notify_joining设置为TRUE时存在</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;id&quot;：&lt;与会者＃1的唯一ID&gt;，</span><br><span class="line">                        &quot;display&quot;：&quot;&lt;与会者＃1的名称，如果有的话&gt;&quot;</span><br><span class="line">                &#125;，</span><br><span class="line">                &#x2F;&#x2F;其他参加者</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，如果房间中当前没有人，则<code>发布者</code>列表为空。上面格式中的<code>private_id</code>属性只有在用户订阅时才起作用。</p></blockquote><p>对于房间里的订阅者来说，会收到<code>event</code>通知。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        “joining&quot;：&#123;</span><br><span class="line">                &quot;id&quot;：&lt;参与者ID&gt;，</span><br><span class="line">                &quot;display&quot;：&quot;&lt;参与者名称&gt;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果你想成为<code>发布者</code>，则发送<code>publish</code>请求。该请求必须跟着一个<code>JSEP SDP Offer</code>，用于协商新的<code>PeerConnection</code>。插件会将其与房间配置进行匹配（例如，确保房间中使用协商的编解码器），并使用<code>JSEP SDP answer</code>进行答复从而完成<code>PeerConnection</code>的设置。建立<code>PeerConnection</code>后，发布者立即处于活动状态，其他参与者就可以订阅它发布的流啦。</p><p><code>publish</code>请求格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;publish&quot;，</span><br><span class="line">        &quot;audio&quot;：&lt;true | false，是否应该转发音频；默认为true&gt;，</span><br><span class="line">        &quot;video&quot;：&lt;true | false，是否应该转发视频；默认为true&gt;，</span><br><span class="line">        &quot;data&quot;：&lt;true | false，是否应该转发数据；默认为true&gt;，</span><br><span class="line">        &quot;audiocodec&quot;：&quot;&lt;在协商协议中首选的音频编解码器；可选&gt;&quot;，</span><br><span class="line">        &quot;videocodec&quot;：&quot;&lt;在协商协议中首选的视频编解码器；可选&gt;&quot;，</span><br><span class="line">        &quot;bitrate&quot;：&lt;通过REMB返回的比特率上限；可选，如果存在则覆盖全局房间值&gt;，</span><br><span class="line">        &quot;record&quot;：&lt;true | false，是否应该记录此发布者；可选&gt;</span><br><span class="line">        &quot;filename&quot;：&quot;&lt;录制文件名；可选&gt;&quot;，</span><br><span class="line">        &quot;display&quot;：&quot;&lt;用户名称；可选&gt;&quot;，</span><br><span class="line">        &quot;audio_level_average&quot;：&quot;&lt;音频音量平均值，此设置覆盖房间的audio_level_average；可选&gt;&quot;，</span><br><span class="line">        &quot;audio_active_packets&quot;：&quot;&lt;音频保活包数，此设置覆盖房间audio_active_packets；可选&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此请求应该与发布者的<code>JSEP SDP Offer</code>一起提供，插件收到此消息后，将协商与之匹配的<code>JSEP SDP Answer</code>。如果成功，<code>configured</code>事件将被返回，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;configured&quot;：“ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该事件将与准备好的<code>JSEP SDP Answer</code>一起发送给客户端。</p><p>你也可以用<code>configure</code>请求代替<code>publish</code>。两者的功能在<code>发布</code>上是等效的，但从语义的角度来看，<code>publish</code>是发布时要发送的正确消息。<code>configure</code>请求也可以用于更新发布者会话的某些属性，在这种情况下，就不能用<code>publish</code>请求了。</p><blockquote><p>需要注意的是，如果用户已经发送过<code>publish</code>了，再发送<code>publish</code>将导致失败。</p></blockquote><p>其实，您可以将<code>join</code>和<code>publish</code>两个API合并为一个API请求。比如你一开始以<code>参与者</code>的身份加入，随后变为<code>发布者</code>，这时你就可以将他们合并。你可以使用<code>joinandconfigure</code>请求来做到这一点，该请求将这两个请求（join与publish)结合在一起。如果成功，则响应一个<code>joined</code>事件，并且将<code>JSEP SDP Answer</code>一起发送出去。</p><p>一旦<code>PeerConnection</code>设置成功，且发布者处于激活状态，<code>event</code>就会被发向房间中的所有<code>参与者</code>。其格式如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        “publishers&quot;：[</span><br><span class="line">                &#123;</span><br><span class="line">                        &quot;id&quot;：&lt;新发布者的唯一ID&gt;，</span><br><span class="line">                        &quot;display&quot;：&quot;&lt;新发布者的名称，如果有的话&gt;&quot;，</span><br><span class="line">                        &quot;audio_codec&quot;：&quot;&lt;新布者使用的音频编解码器，如果有的话&gt;&quot;，</span><br><span class="line">                        &quot;video_codec&quot;：&quot;&lt;新发布使用的视频编解码器，如果有的话&gt;&quot;，</span><br><span class="line">                        &quot;simulcast&quot;：&quot;&lt;如果发布者使用simucast，则为true（仅VP8和H.264）&gt;&quot;，</span><br><span class="line">                        &quot;talking&quot;：&lt;true | false，发布者是否在讲话（仅在使用音频级别的情况下）&gt;，</span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要停止发布并删除相关的<code>PeerConnection</code>，可以使用该<code>unpublish</code>请求：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：“unpublish&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当插件收到这条请求后，它会删除对应的<code>PeerConnection</code>，并将发布者从活动列表中删除。如果成功，响应如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        “unpublish&quot;：“ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当<code>PeerConnection</code>删除后，插件还将向所有其他<code>参与者</code>通知该流不再可用的消息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;unpublished&quot;：&lt;发布者的ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，不光收到<code>unpublish</code>消息会触发上面的事件通知，其实无论什么情况下，只要<code>发布者</code>提供的流消失了（例如，句柄已关闭或用户失去连接），都会发同样的<code>事件</code>。此外，你可以使用同一句柄的上下文多次执行<code>发布</code>或<code>取消发布</code>操作。</p></blockquote><p>正如我们上面讲过的，你可以使用<code>configure</code>请求调整发布者会话的某些属性。该请求的格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;configure&quot;，</span><br><span class="line">        &quot;audio&quot;：&lt;true | false，取决于是否应该转发音频；默认为true&gt;，</span><br><span class="line">        &quot;video&quot;：&lt;true | false，取决于是否应该转发视频；默认为true&gt;，</span><br><span class="line">        &quot;data&quot;：&lt;true | false，取决于是否应该转发数据；默认为true&gt;，</span><br><span class="line">        &quot;bitrate&quot;：&lt;比特率上限；可选，如果存在则覆盖全局房间值（除非设置了bitrate_cap）&gt;，</span><br><span class="line">        &quot;keyframe&quot;：&lt;true | false，是否向发布者发送关键帧请求&gt;，</span><br><span class="line">        &quot;record&quot;：&lt;true | false，是否开启录制；可选&gt;</span><br><span class="line">        &quot;filename&quot;：&quot;&lt;如果开启了录制，指明录制路径&#x2F;文件；可选&gt;&quot;，</span><br><span class="line">        &quot;display&quot;：&quot;&lt;用户名称；可选&gt;&quot;，</span><br><span class="line">        &quot;audio_active_packets&quot;：&quot;&lt;音频保活包个数，audio_active_packets；可选&gt;&quot;，</span><br><span class="line">        &quot;audio_level_average&quot;：&quot;&lt;音频音量平均值，audio_level_average；可选&gt;&quot;，</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>configure</code>基本上与<code>publish</code>的属性相同。这就是为什么两个请求都可以用来开始发布的原因。如果<code>configure</code>成功，则返回<code>configured</code>事件，格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;configured&quot;：“ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当发送<code>configure</code>请求RTP扩展<code>ssrc-audio-level</code>时，如果<code>audiolevel_event</code>设置为true ，则可能会向所有发布者发送一些临时事件。这些事件将具有以下格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&lt;&quot;talking&quot;|&quot;stopped-talking&quot;，是否发布者开始或停止发言&gt;，</span><br><span class="line">        &quot;room&quot;：&lt;房间的唯一ID&gt;，</span><br><span class="line">        &quot;id&quot;：&lt;发布者的唯一ID&gt;，</span><br><span class="line">        &quot;audio-level-dBov-avg&quot;：&lt;音平音量的平均值，127 &#x3D;静音，0 &#x3D;&#39;太大声&#39;&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>VideoRoom</code>插件的主要目的是从WebRTC源(发布者)获取媒体，并将其转发到WebRTC目的地（订阅者），但实际上存在几种方案，可以将媒体转发给外部（不一定与WebRTC兼容）组件。例如，用于媒体处理，外部录制，转码，级联等等。<code>rtp_forward</code>顾名思义，就是将发布者发送的RTP包（普通或加密）实时转发到远程后端。</p><p>您可以使用<code>rtp_forward</code>请求为现有发布者添加新的RTP转发器，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;rtp_forward&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;publisher_id&quot;：&lt;发布者ID&gt;，</span><br><span class="line">        &quot;host&quot;：&quot;&lt;将RTP和数据包转发到的host主机IP地址&gt;&quot;，</span><br><span class="line">        &quot;host_family&quot;：&quot;&lt;ipv4 | ipv6，使用IPv4还是IPv6；默认情况下，无论我们得到什么&gt;&quot;，</span><br><span class="line">        &quot;audio_port&quot;：&lt;音频RTP数据包转发到的端口&gt;，</span><br><span class="line">        &quot;audio_ssrc&quot;：&lt;音频SSRC，用于流式传输；可选&gt;</span><br><span class="line">        &quot;audio_pt&quot;：&lt;音频有效负载类型；可选&gt;</span><br><span class="line">        &quot;audio_rtcp_port&quot;：&lt;接收方接收音频RTCP反馈端口；可选，当前未用于音频&gt;，</span><br><span class="line">        &quot;video_port&quot;：&lt;将视频RTP数据包转发到的端口&gt;，</span><br><span class="line">        &quot;video_ssrc&quot;：&lt;视频 SSRC；可选&gt;</span><br><span class="line">        &quot;video_pt&quot;：&lt;视频有效载荷类型；可选&gt;</span><br><span class="line">        &quot;video_rtcp_port&quot;：&lt;接收方接收视频RTCP反馈端口；可选&gt;</span><br><span class="line">        &quot;video_port_2&quot;：&lt;如果simulcast，则视频第二个的RTP数据端口&gt;，</span><br><span class="line">        &quot;video_ssrc_2&quot;：&lt;如果simulcast，则视频第二个的SSRC；可选&gt;</span><br><span class="line">        &quot;video_pt_2&quot;：&lt;如果simulcast，则视频第二个的有效载荷类型；可选&gt;</span><br><span class="line">        &quot;video_port_3&quot;：&lt;如果simulcast，则视频第三个RTP数据包端口&gt;，</span><br><span class="line">        &quot;video_ssrc_3&quot;：&lt;如果simulcast，则视频第三个SSRC；可选&gt;</span><br><span class="line">        &quot;video_pt_3&quot;：&lt;如果simulcast，则视频第三个的有效载荷类型；可选&gt;</span><br><span class="line">        &quot;data_port&quot;：&lt;数据通道消息端口&gt;，</span><br><span class="line">        &quot;srtp_suite&quot;：&lt;身份验证标签的长度（32或80）；可选&gt;</span><br><span class="line">        &quot;srtp_crypto&quot;：&quot;&lt;用作加密的密钥（如SDES中的base64编码的密钥；可选&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，如上所述，如果您配置了admin_key属性，则在请求中也需要提供它，否则未授权的请求将被拒绝。默认情况下，没有对rtp_forward进行限制。</p></blockquote><p>如果请求成功则返回<code>rtp_forward</code>响应，其中格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;rtp_forward&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;publisher_id&quot;：&lt;发布者ID&gt;</span><br><span class="line">        &quot;rtp_stream&quot;：&#123;</span><br><span class="line">                &quot;host&quot;：&quot;&lt;接收流的主机IP，如果未解析，则与请求相同&gt;&quot;，</span><br><span class="line">                &quot;audio&quot;：&lt;音频RTP端口，与请求相同（如果已配置）&gt;，</span><br><span class="line">                &quot;audio_rtcp&quot;：&lt;音频RTCP端口，与请求相同（如果已配置）&gt;，</span><br><span class="line">                &quot;audio_stream_id&quot;：&lt;分配给音频RTP转发器的唯一数字ID，如果有的话，&gt;</span><br><span class="line">                &quot;video&quot;：&lt;视频RTP端口，与请求相同（如果已配置）&gt;，</span><br><span class="line">                &quot;video_rtcp&quot;：&lt;视频RTCP端口，如果配置，则与请求相同，&gt;</span><br><span class="line">                &quot;video_stream_id&quot;：&lt;分配给主视频RTP转发器的唯一数字ID，如果有的话，&gt;</span><br><span class="line">                &quot;video_2&quot;：&lt;第二个视频端口，与请求相同（如果已配置）&gt;，</span><br><span class="line">                &quot;video_stream_id_2&quot;：&lt;分配给第二层视频RTP转发器的唯一数字ID，如果有的话，&gt;</span><br><span class="line">                &quot;video_3&quot;：&lt;第三个视频端口，与请求相同（如果已配置）&gt;，</span><br><span class="line">                &quot;video_stream_id_3&quot;：&lt;分配给第三个视频RTP转发器的唯一数字ID，如果有，&gt;</span><br><span class="line">                &quot;data&quot;：&lt;数据端口，与请求相同（如果已配置）&gt;，</span><br><span class="line">                &quot;data_stream_id&quot;：&lt;分配给数据通道消息转发器的唯一数字ID（如果有）&gt;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要停止以前创建的RTP转发器，可以使用<code>stop_rtp_forward</code>请求，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;stop_rtp_forward&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;publisher_id&quot;：&lt;发布者ID&gt;，</span><br><span class="line">        &quot;stream_id&quot;：&lt;RTP转发器ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求成功，则返回<code>stop_rtp_forward</code>响应：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;stop_rtp_forward&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;publisher_id&quot;：&lt;发布者ID，与请求相同，&gt;</span><br><span class="line">        &quot;stream_id&quot;：&lt;流ID，与请求相同&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果要获取特定房间中所有转发器的列表，可以使用<code>listforwarders</code>请求，其格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;listforwarders&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间的唯一数字ID&gt;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;房间密码；如果已配置，则是必需的&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请求成功，则返回forwarders响应，其中包括RTP转发器列表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;forwarders&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间的唯一ID&gt;，</span><br><span class="line">        &quot;rtp_forwarders&quot;：[&#x2F;&#x2F;具有RTP转发器的发布者数组</span><br><span class="line">                &#123;&#x2F;&#x2F;发布者＃1</span><br><span class="line">                        &quot;publisher_id&quot;：&lt;发布者＃1的唯一数字ID&gt;，</span><br><span class="line">                        &quot;rtp_forwarders&quot;：[&#x2F;&#x2F; RTP转发器数组</span><br><span class="line">                                &#123;&#x2F;&#x2F; RTP转发器＃1</span><br><span class="line">                                        &quot;audio_stream_id&quot;：&lt;音频RTP转发器的唯一ID，如果有的话&gt;，</span><br><span class="line">                                        &quot;video_stream_id&quot;：&lt;视频RTP转发器的唯一ID，如果有的话&gt;，</span><br><span class="line">                                        &quot;data_stream_id&quot;：&lt;数据通道消息转发器的唯一ID（如果有）&gt;，</span><br><span class="line">                                        &quot;ip&quot;：&quot;&lt;接收端IP&gt;&quot;，</span><br><span class="line">                                        &quot;port&quot;：&lt;接收端端口&gt;，</span><br><span class="line">                                        &quot;rtcp_port&quot;：&lt;接收端RTCP端口，如果有的话&gt;，</span><br><span class="line">                                        &quot;ssrc&quot;：&lt;转发器正在使用的SSRC，如果有的话&gt;，</span><br><span class="line">                                        &quot;pt&quot;：&lt;转发器正在使用的有效负载类型&gt;，</span><br><span class="line">                                        &quot;substream&quot;：&lt;视频子流，如果有&gt;，</span><br><span class="line">                                        &quot;srtp&quot;：&lt;true | false，RTP流是否已加密&gt;</span><br><span class="line">                                &#125;，</span><br><span class="line">                                &#x2F;&#x2F;此发布者的其他转发器</span><br><span class="line">                        ]，</span><br><span class="line">                &#125;，</span><br><span class="line">                &#x2F;&#x2F;其他发布者</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在会议进行期间启用或禁用录制，您可以使用<code>enable_recording</code>请求，该请求的格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;enable_recording&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;secret&quot;：&quot;&lt;房间密码；如果已配置，则是必需的&gt;&quot;</span><br><span class="line">        &quot;record&quot;：&lt;true | false，是否自动记录此会议室中的参与者&gt;，</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，参与者通常也可以通过configure请求来更改自己的录制状态：这样做是为了获得最大的灵活性，您可能希望单独记录一些流，而不是全局或自动记录一些内容，到特定文件。就是说，如果你希望确保在启用全局录制后参与者不能停止其录制，或者在不应该录制该会议室的情况下启动它，那么您应该确保在创建会议室时使用lock_record属性，将其设置为true。这样，只有在提供了房间密码的情况下，才能更改录制状态，从而确保只有管理员才能执行此操作。</p></blockquote><p>最后，您可以使用<code>leave</code>请求离开会议室。如果您是会议室中的活动发布者，这也将隐式取消你的发布。该leave请求如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;leave&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果成功，响应将如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;leaving&quot;：&quot;ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他参与者将收到”leaving”事件，格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;leaving：&lt;离开的参与者的唯一ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果您是活跃的发布者，则其他用户也将收到相应的<code>unpublish</code>事件，以通知他们该流不再可用。如果您只是潜伏而不是发布者，则其他参与者将仅收到”leave”事件。</p><h2 id="VideoRoom-订阅者"><a href="#VideoRoom-订阅者" class="headerlink" title="VideoRoom 订阅者"></a>VideoRoom 订阅者</h2><p>订阅者在加入房间时，join请求的ptype属性应该设置为<code>subscriber</code>，并指定要订阅的确切的媒体流。该请求的确切语法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;join&quot;，</span><br><span class="line">        &quot;ptype&quot;：&quot;subscriber&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;feed&quot;：&lt;发布者ID；强制性&gt;，</span><br><span class="line">        &quot;private_id&quot;：&lt;发起此请求的用户ID；可选的，除非房间配置要求&gt;</span><br><span class="line">        &quot;close_pc&quot;：&lt;true | false，发布者离开时是否应自动关闭PeerConnection；默认为true&gt;，</span><br><span class="line">        &quot;audio&quot;：&lt;true | false，是否转发音频；默认为true&gt;，</span><br><span class="line">        &quot;video&quot;：&lt;true | false，是否转发视频；默认为true&gt;，</span><br><span class="line">        &quot;data&quot;：&lt;true | false，是否转发数据；默认为true&gt;，</span><br><span class="line">        &quot;offer_audio&quot;：&lt;true | false; 是否应该协商音频；如果发布者的音频&gt;，默认为true</span><br><span class="line">        &quot;offer_video&quot;：&lt;true | false; 是否应该协商视频；如果发布者的视频&gt;，默认为true</span><br><span class="line">        &quot;offer_data&quot;：&lt;true | false; 是否应该协商数据通道；如果发布者的datachannels&gt;为默认值，则为true</span><br><span class="line">        &quot;substream&quot;：&lt;启用了simulcast情况下，要接收的子流（0-2）；可选&gt;</span><br><span class="line">        &quot;temporal&quot;：&lt;启用simulcast情况下，要接收的时间层（0-2）；可选&gt;</span><br><span class="line">        &quot;fallback&quot;：&lt;多少时间（在我们这里，默认为250000）没有接收到数据包将使我们下降到下面的子流&gt;，</span><br><span class="line">        &quot;spatial_layer&quot;：&lt;启用VP9-SVC时要接收的空间层（0-2）；可选&gt;</span><br><span class="line">        &quot;temporal_layer&quot;：&lt;启用VP9-SVC时要接收的时间层（0-2）；可选&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如您所见，只要指定好要订阅的发布者ID，并在需要时指定好<code>private_id</code>(订阅者ID)，其它的都可以不设置。不过请求中的<code>offer_audio</code>，<code>offer_video</code>和<code>offer_data</code>特别有意思，你可以通过它们订阅媒体的一个子集(音频\视频\数据）。</p><p>默认情况下，发送<code>join</code>请求时会导致插件层创建<code>SDP Offer</code>，用以协商发布者提供那些媒体。此外，如果发布者发布的是<code>simulcast</code>或<code>VP9 SVC</code>，那么你还可以订阅你感兴趣的子流，例如，获得最佳质量的中间质量。更有意思的是，你可以使用<code>configure</code>请求随时动态更改这些设置。</p><p>上面的请求如果成功，将生成一个新的<code>JSEP SDP Offer</code>，并伴随一个attached事件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;attached&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;feed&quot;：&lt;发布者ID&gt;，</span><br><span class="line">        &quot;display&quot;：&quot;&lt;发布者的名称，如果有的话&gt;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在此阶段，为了完成<code>PeerConnection</code>的设置，订阅者应将<code>JSEP SDP Answer</code>发送回插件。此操作是通过<code>start</code>请求来完成的，在这种情况下，请求必须与<code>JSEP SDP Answer</code>相关联，但是不需要任何参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：“start&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果成功，此请求将返回一个started事件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;started&quot;：&quot;ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完成此操作后，所需要做的就是等待WebRTC <code>PeerConnection</code>建立成功。一旦<code>PeerConnection</code>建立成功，Streaming插件就可以开始向订阅的观众转发媒体了。</p><blockquote><p>注意，在需要重新协商（例如出于ICE重启目的）的情况下，您也可以使用我们刚经历的相同步骤（watch请求，然后插件创建<code>JSEP Offer</code>，最后客户端发送<code>start</code>请求和<code>JSEP Answer</code>）。</p></blockquote><p>作为<code>订阅者</code>，您可以发送<code>pause</code>临时暂停或发送<code>start</code>恢复整个媒体的传送（在这种情况下，不附带任何JSEP SDP Answer）。因为上下文中已经有了相关信息，所以不需要重新进行协商。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;pause&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;start&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然，它们会分别导致paused和started事件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;paused&quot;：&quot;ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;started&quot;：&quot;ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>configure</code>请求可以对<code>订阅</code>做更多深入操作。该请求允许<code>订阅者</code>动态更改与媒体订阅有关的某些属性，<code>configure</code>请求的格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;configure&quot;，</span><br><span class="line">        &quot;audio&quot;：&lt;true | false，是否应该转发音频；可选&gt;</span><br><span class="line">        &quot;video&quot;：&lt;true | false，是否应该转发视频；可选&gt;</span><br><span class="line">        &quot;data&quot;：&lt;true | false，是否转发数据；可选&gt;</span><br><span class="line">        &quot;substream&quot;：&lt;启用simulcast情况下，要接收的子流（0-2）；可选&gt;</span><br><span class="line">        &quot;temporal&quot;：&lt;启用simulcast，要接收的时间层（0-2）；可选&gt;</span><br><span class="line">        &quot;fallback&quot;：&lt;多少时间（在我们这里，默认为250000）没有接收到数据包将使我们下降到下面的子流&gt;，</span><br><span class="line">        &quot;spatial_layer&quot;：&lt;启用VP9-SVC时要接收的空间层（0-2）；可选&gt;</span><br><span class="line">        &quot;temporal_layer&quot;：&lt;启用VP9-SVC时要接收的时间层（0-2）；可选&gt;</span><br><span class="line">        &quot;audio_level_average&quot;：&quot;&lt;如果提供，将覆盖此用户的房间audio_level_average；可选&gt;&quot;，</span><br><span class="line">        &quot;audio_active_packets&quot;：&quot;&lt;如果提供，将覆盖此用户的房间audio_active_packets；可选&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正如你所看到的audio，video和data属性可以用作媒体级的暂停/恢复功能，而pause与start只是简单地暂停/恢复所有数据流。</p><p>下面来说说<code>switch</code>，switch 请求格式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;switch&quot;，</span><br><span class="line">        &quot;feed&quot;：&lt;要切换到的新发布者的唯一ID；强制性&gt;，</span><br><span class="line">        &quot;audio&quot;：&lt;true | false，取决于是否应该中继音频；可选&gt;</span><br><span class="line">        &quot;video&quot;：&lt;true | false，取决于是否应该中继视频；可选&gt;</span><br><span class="line">        &quot;data&quot;：&lt;true | false，取决于是否应该中继数据通道消息；可选&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果成功，您将退订之前的发布者，然后订阅新的发布者。确认切换成功的事件如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;switched&quot;：&quot;ok&quot;，</span><br><span class="line">        &quot;room&quot;：&lt;房间ID&gt;，</span><br><span class="line">        &quot;id&quot;：&lt;新发布者的唯一ID&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后，要停止订阅并删除相关的PeerConnection，可以使用该leave请求。由于上下文是隐式的，因此不需要其他参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;request&quot;：&quot;leave&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果成功，该插件将尝试拆除PeerConnection，并发送回一个left事件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;videoroom&quot;：&quot;event&quot;，</span><br><span class="line">        &quot;left&quot;：&quot;ok&quot;，</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>VideoRoom</code>插件是Janus的一个特别重要的插件，对于该插件的理解对于我们理解整个Janus有至关重要的意义。本文说细分析了<code>VideoRoom</code>插件中所有的信令，大体上我们可以将它们人成两在类，一类是房间管理信令，另一类是用户信令。</p><p>这些信令设计的非常巧妙，对我们研发自己的SFU会议系统是一个很好的借鉴。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://avdancedu.com/947c722a/" target="_blank" rel="noopener">多人实时互动之各WebRTC流媒体服务器比较</a><br><a href="https://avdancedu.com/d7281c13/" target="_blank" rel="noopener">janus前端核心库源码分析</a></p></div><div class="reward-container"><div></div> <button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'> 打赏</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="https://cdn.avdancedu.com/image/next/wechat.jpeg" alt="音视跳动 微信支付"><p>微信支付</p></div><div style="display:inline-block"> <img src="https://cdn.avdancedu.com/image/next/alipay.jpeg" alt="音视跳动 支付宝"><p>支付宝</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> 音视跳动-李超 [avdance@163.com]</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://blog.avdancedu.com/bb906872/" title="janus的videoroom插件">https://blog.avdancedu.com/bb906872/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://cdn.avdancedu.com/image/next/WeChat.jpeg"><span class="icon"><i class="fa fa-wechat"></i></span> <span class="label">WeChat</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/videoroom/" rel="tag"><i class="fa fa-tag"></i> videoroom</a></div><div class="post-nav"><div class="post-nav-item"><a href="/af19ebea/" rel="prev" title="WebRTC常见问题"><i class="fa fa-chevron-left"></i> WebRTC常见问题</a></div><div class="post-nav-item"> <a href="/12dc77f9/" rel="next" title="音视频学习路线图">音视频学习路线图<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#VideoRoom插件"><span class="nav-number">1.</span> <span class="nav-text">VideoRoom插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Video-Room-可以使用的API"><span class="nav-number">2.</span> <span class="nav-text">Video Room 可以使用的API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VideoRoom-发布者"><span class="nav-number">3.</span> <span class="nav-text">VideoRoom 发布者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VideoRoom-订阅者"><span class="nav-number">4.</span> <span class="nav-text">VideoRoom 订阅者</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">5.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="音视跳动" src="/images/avdancelogo.jpg"><p class="site-author-name" itemprop="name">音视跳动</p><div class="site-description" itemprop="description">传输最前沿的科技知识，学习音视频的圣地！ffmpeg, webrtc, H264, AAC</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">26</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/avdance" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;avdance" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/garrylea/posts" title="ZhiHu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;garrylea&#x2F;posts" rel="noopener" target="_blank"><i class="fa fa-fw fa-zhihu"></i> ZhiHu</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备19056322号-1</a> <img src="/images/beianico.png" style="display:inline-block"><a href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11011102001366" rel="noopener" target="_blank">京公网安备11011102001366号</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">李超</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">180k</span></div><script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"Cu6h7B3RnNt3uEMrRWpVlIU6-gzGzoHsz","app_key":"5dKv9XFD2w3gjJnb0xnWIIWz","server_url":"https://leancloud.cn","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        //if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("Cu6h7B3RnNt3uEMrRWpVlIU6-gzGzoHsz","5dKv9XFD2w3gjJnb0xnWIIWz")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.min.css"><script src="/lib/needsharebutton/needsharebutton.min.js"></script><script>flOptions={iconStyle:"box",boxForm:"horizontal",position:"topRight",networks:"Weibo,Wechat,QQZone"},new needShareButton("#needsharebutton-float",flOptions)</script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('/lib/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Cu6h7B3RnNt3uEMrRWpVlIU6-gzGzoHsz',
      appKey     : '5dKv9XFD2w3gjJnb0xnWIIWz',
      placeholder: "畅所欲言？",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script></body></html>